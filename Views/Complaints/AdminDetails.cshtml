@model ComplaintManagementSystem.Models.Complaint
@using ComplaintManagementSystem.Models
@{
    ViewData["Title"] = $"Complaint #{Model.Id} - Admin Review";
    
    // Helper to determine status badge color
    string GetStatusClass(ComplaintStatus status) => status switch
    {
        ComplaintStatus.Resolved => "bg-success",
        ComplaintStatus.InProgress => "bg-warning text-dark",
        _ => "bg-secondary",
    };
}

@* Ensure this using directive is at the top if not using the default imports *@
@* @using Microsoft.AspNetCore.Mvc.TagHelpers *@ 

<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-center pb-2 border-bottom">
        <h2><i class="bi bi-file-earmark-lock-fill text-dark"></i> Complaint #@Model.Id: @Model.Title</h2>
        
        <a asp-controller="Admin" asp-action="Dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <div class="row mt-4">
        
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h5><i class="bi bi-info-circle"></i> Complaint Status & Stats</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Current Status:</strong> 
                        <span class="badge @GetStatusClass(Model.Status) p-2 fs-6">
                            @Model.Status
                        </span>
                    </p>
                    <p class="mb-2"><strong>Category:</strong> <span class="badge bg-primary p-1">@Model.Category</span></p>
                    <p class="mb-2"><strong>Submitted:</strong> @Model.SubmittedAt.ToString("MMM dd, yyyy @ hh:mm tt")</p>
                    <p class="mb-2"><strong>Likes:</strong> <i class="bi bi-heart-fill text-danger"></i> @Model.LikesCount</p>
                    <p class="mb-2"><strong>Comments:</strong> <i class="bi bi-chat-fill text-primary"></i> @Model.Comments.Count</p>

                    <hr />
                    
                    <div class="dropdown">
                         <button type="button" class="btn btn-sm btn-outline-dark dropdown-toggle w-100" 
                                 data-bs-toggle="dropdown">
                            Change Status
                        </button>
                        <ul class="dropdown-menu w-100">
                             
                            @if (Model.Status != ComplaintStatus.Pending)
                            {
                                <li>
                                    <form asp-controller="Admin" asp-action="UpdateStatus" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@Model.Id" />
                                        <input type="hidden" name="status" value="@ComplaintStatus.Pending" />
                                        <button type="submit" class="dropdown-item"><i class="bi bi-hourglass"></i> Mark as Pending</button>
                                    </form>
                                </li>
                            }
                            @if (Model.Status != ComplaintStatus.InProgress)
                            {
                                <li>
                                    <form asp-controller="Admin" asp-action="UpdateStatus" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@Model.Id" />
                                        <input type="hidden" name="status" value="@ComplaintStatus.InProgress" />
                                        <button type="submit" class="dropdown-item"><i class="bi bi-gear"></i> Mark as In Progress</button>
                                    </form>
                                </li>
                            }
                            @if (Model.Status != ComplaintStatus.Resolved)
                            {
                                <li>
                                    <form asp-controller="Admin" asp-action="UpdateStatus" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@Model.Id" />
                                        <input type="hidden" name="status" value="@ComplaintStatus.Resolved" />
                                        <button type="submit" class="dropdown-item"><i class="bi bi-check-circle"></i> Mark as Resolved</button>
                                    </form>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-card-text"></i> Description</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">@Model.Description</p>
                    <hr />
                    <p class="mb-0"><strong>Reported By:</strong> @Model.StudentName</p>
                    <p class="mb-0"><strong>Anonymity:</strong> <span class="badge @(Model.IsAnonymous ? "bg-danger" : "bg-success")">@(Model.IsAnonymous ? "Anonymous" : "Public Name")</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-info text-white">
                    <h5><i class="bi bi-chat-left-text-fill"></i> Discussion and Notes</h5>
                </div>
                <div class="card-body">
                    <div class="comments-section" style="max-height: 400px; overflow-y: auto; padding-right: 15px;">
                        @if (Model.Comments.Any())
                        {
                            @foreach (var comment in Model.Comments.OrderBy(c => c.PostedAt))
                            {
                                <div class="card mb-3 @(comment.UserName.ToLower().Contains("admin") ? "border-primary" : "border-light")">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="mb-0">@comment.UserName</h6>
                                            <small class="text-muted">@comment.PostedAt.ToString("MMM dd, yyyy @ HH:mm")</small>
                                        </div>
                                        <p class="card-text mt-1">@comment.Text</p>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted text-center py-3">No comments or official replies have been posted yet.</p>
                        }
                    </div>

                    <hr class="mt-4"/>

                    <h5>Post an Official Reply</h5>
                    <form asp-controller="Complaints" asp-action="AddComment" method="post" class="mt-3">
                         @Html.AntiForgeryToken()
                        <input type="hidden" name="complaintId" value="@Model.Id" />
                        <div class="mb-3">
                            <input type="text" name="userName" class="form-control" value="Admin / [Your Name]" required />
                        </div>
                        <div class="mb-3">
                            <textarea name="commentText" class="form-control" rows="4" placeholder="Type your official response or administrative note here..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-info text-white">
                            <i class="bi bi-send-fill"></i> Post Official Reply
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>